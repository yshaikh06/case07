<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>UVA SDS • Lanternfly Image Uploader & Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- UVA-inspired embedded styles -->
  <style>
    :root{
      --uva-navy:#232D4B;
      --uva-orange:#E57200;
      --uva-blue:#007BAC;
      --gray-50:#fafafa;
      --gray-200:#e5e7eb;
      --gray-600:#4b5563;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", Helvetica;
      background:var(--gray-50);
      color:#0f172a;
    }
    header{
      background:var(--uva-navy);
      color:#fff;
      padding:1rem 1.25rem;
      display:flex; align-items:center; justify-content:space-between;
    }
    header .brand{
      display:flex; gap:.6rem; align-items:center; font-weight:700; letter-spacing:.2px;
    }
    header .pill{
      background:var(--uva-orange);
      color:#111827; font-weight:800; padding:.15rem .5rem; border-radius:.5rem; font-size:.8rem;
    }
    main{ max-width:980px; margin:1rem auto; padding:0 1rem; }
    .card{
      background:#fff; border:1px solid var(--gray-200); border-radius:14px;
      padding:1rem; box-shadow:0 2px 12px rgba(0,0,0,.04); margin-bottom:1rem;
    }
    h1,h2,h3{ color:var(--uva-navy); margin:.2rem 0 .6rem }
    .controls{ display:flex; flex-wrap:wrap; gap:.6rem; align-items:center }
    input[type=file]{ padding:.4rem; border:1px solid var(--gray-200); border-radius:10px; background:#fff; }
    button{
      background:var(--uva-navy); color:#fff; border:1px solid var(--uva-navy);
      padding:.6rem 1rem; border-radius:10px; font-weight:600; cursor:pointer;
    }
    button.secondary{ background:#fff; color:var(--uva-navy) }
    .note{
      background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12;
      padding:.6rem .8rem; border-radius:10px; margin:.6rem 0;
    }
    .grid{
      display:grid; grid-template-columns:repeat(auto-fill, minmax(180px,1fr)); gap:12px;
    }
    .item{ border:1px solid var(--gray-200); border-radius:12px; padding:8px; background:#fff; }
    .thumb{ width:100%; height:160px; object-fit:cover; border-radius:8px; background:#f3f4f6 }
    .cap{ font-size:.82rem; color:var(--gray-600); margin-top:.35rem; word-break:break-all }
    .row{ display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
    .muted{ color:var(--gray-600); font-size:.9rem; }
    footer{ text-align:center; color:var(--gray-600); padding:1.25rem 0; }
    .spinner{ display:inline-block; width:18px; height:18px; border:2px solid #cbd5e1; border-top-color:var(--uva-blue); border-radius:50%; animation:spin 0.8s linear infinite }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    a{ color:var(--uva-blue); text-decoration:none } a:hover{ text-decoration:underline }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <span>UVA SDS • Lanternfly Field Images</span>
      <span class="pill">DEMO</span>
    </div>
    <div class="muted">Public gallery (read) · Authenticated upload (write)</div>
  </header>

  <main>
    <!-- Upload Card -->
    <section class="card">
      <h3>Upload an image</h3>
      <div class="note">
        Images will be stored in the Azure Blob container (public-read). Uploads require server credentials; viewing is public.
      </div>
      <div class="controls">
        <input type="file" id="f" accept="image/*" capture="environment" />
        <button id="uploadBtn" onclick="send()">Upload</button>
        <button class="secondary" onclick="document.getElementById('f').value='';">Reset</button>
        <span id="uploadStatus" class="muted" aria-live="polite"></span>
      </div>
    </section>

    <!-- Gallery Card -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">Gallery</h3>
        <div class="row muted">
          <span id="count">0 images</span>
          <button class="secondary" onclick="loadGallery()" title="Refresh gallery">Refresh</button>
        </div>
      </div>
      <div id="galleryNote" class="note" style="display:none"></div>
      <div id="grid" class="grid" aria-live="polite">
        <!-- images injected here -->
      </div>
    </section>
  </main>

  <footer>Built with Flask · Azure Blob Storage · UVA-inspired styling</footer>

  <script>
    const grid = document.getElementById('grid');
    const countEl = document.getElementById('count');
    const noteEl  = document.getElementById('galleryNote');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadStatus = document.getElementById('uploadStatus');

    function setUploading(isUploading){
      uploadBtn.disabled = isUploading;
      uploadStatus.textContent = isUploading ? "Uploading… " : "";
      if(isUploading){
        uploadStatus.innerHTML = '<span class="spinner" style="vertical-align:-3px"></span> Uploading…';
      }
    }

    async function send(){
      const fileInput = document.getElementById('f');
      const file = fileInput.files[0];
      if(!file){ alert("Choose a file first."); return; }
      try{
        setUploading(true);
        const fd = new FormData();
        fd.append("file", file);
        const r = await fetch("/api/v1/upload", { method: "POST", body: fd });
        const j = await r.json().catch(()=> ({}));
        if(!r.ok || !j.ok){
          throw new Error(j.error || ("Upload failed (" + r.status + ")"));
        }
        // Success: show URL and refresh the gallery without full page reload
        alert("Uploaded: " + j.url);
        fileInput.value = "";
        await loadGallery();
      }catch(err){
        console.error(err);
        alert("Upload error: " + err.message);
      }finally{
        setUploading(false);
      }
    }

    function renderGallery(urls){
      grid.innerHTML = "";
      if(!Array.isArray(urls) || urls.length === 0){
        countEl.textContent = "0 images";
        noteEl.style.display = "block";
        noteEl.textContent = "No images yet. Upload one above.";
        return;
      }
      noteEl.style.display = "none";
      countEl.textContent = urls.length + (urls.length === 1 ? " image" : " images");
      for(const u of urls){
        const item = document.createElement("div");
        item.className = "item";
        const img = document.createElement("img");
        img.className = "thumb";
        img.src = u;
        img.alt = "Lanternfly observation";
        const cap = document.createElement("div");
        cap.className = "cap";
        cap.textContent = (u.split("/").pop() || u);
        item.appendChild(img);
        item.appendChild(cap);
        grid.appendChild(item);
      }
    }

    // Fetch gallery from the API:
    // Expected shape:
    // { "ok": true, "gallery": ["https://<app-host>/lanternfly-images/20251021T194550-fly2.png", ...] }
    async function loadGallery(){
      // Show a lightweight loading state
      grid.innerHTML = '<div class="muted" style="padding:.5rem 0;"><span class="spinner"></span> Loading gallery…</div>';
      try{
        const r = await fetch("/api/v1/gallery", { headers: { "Accept": "application/json" }});
        const j = await r.json().catch(()=> ({}));
        if(!r.ok || !j.ok){
          throw new Error(j.error || ("Failed to load gallery (" + r.status + ")"));
        }
        renderGallery(j.gallery || []);
      }catch(err){
        console.error(err);
        noteEl.style.display = "block";
        noteEl.textContent = "Could not load gallery: " + err.message;
        grid.innerHTML = "";
        countEl.textContent = "0 images";
      }
    }

    // Auto-load on first paint
    document.addEventListener("DOMContentLoaded", loadGallery);
  </script>
</body>
</html>
